{% extends "base.html" %}

{% block title %}Parts || Inventory{% endblock %}

{% block content %}
<!--
GPT4.0 mini prompt:

Below is the code I use to present a form to allow a user to add a part to an inventory database. In the same style, can you write a page to list items from that database in a paginated manner? The page should allow users to search for items, view the results, and access delete or edit functions.

By default, the page should display all items in the database, paginated in groups of ten. The items are fetched by calling a lambda function URL http://myfunctionurl.on.aws.

When the user changes the search field input, please clear the existing list of items, and update it based on the search input. Search results will be fetched by calling a lambda function url.

Can you suggest a way to display the parts that is mobile-friendly, so a mobile user does not have to scroll to see all of the data?

How can I show an indicator to the user during the loading process? I would like it to include the message "Please wait while we load parts..."

How can I include a standardized, easy-to-use "Add" button to allow a user to add a new part to the database?

I would like the page to be titled "Inventory Management :: Search."

-- Then --
Given the following HTML template, can you modify it to display parts from the Django parts database, and write a view to paginate, fetch, and display the parts?
-->
<div aria-live="polite" aria-atomic="true" style="position: relative; z-index: 1050;">
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <!-- Toasts will be dynamically added here -->
    </div>
</div>


<div class="container">
    <button id="addPartButton" class="btn btn-warning float-right mb-2" onclick="window.location.href='/add.html'">Add Part</button>
    <h1>Inventory</h1>
    <input type="text" id="searchInput" class="form-control" placeholder="Search for parts..." oninput="searchParts()">
    <div id="loadingIndicator" class="loading">
        <strong>Please wait while we load parts...</strong>
        <div class="spinner-border spinner-border-sm" role="status"></div>
    </div>
    <div id="errorMessage" class="error text-center mt-3"></div>
    <div id="successMessage" class="success text-center mt-3"></div>
    <div id="partsList" class="mt-4"></div>
    <div id="pagination" class="mt-4"></div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this item? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentPage = 1;
    const itemsPerPage = 10; // Adjust this to match the pagination in the view
    let inventoryParts = [];
    let partIdToDelete;

    function fetchParts(searchTerm = '', page = 1) {
        $('#loadingIndicator').show();
        clearPage();

        $.ajax({
            url: `/parts/fetch?page=${page}&search=${searchTerm}`, // Adjust the URL to match your Django URL
            type: 'GET',
            success: function(response) {
                $('#loadingIndicator').hide();
                if (response.items && response.items.length > 0) {
                    inventoryParts = response.items;
                    displayParts(inventoryParts);
                    setupPagination(response);
                    searchParts();
                } else {
                    $('#partsList').html('<p>No parts found.</p>');
                }
            },
            error: function(xhr, status, error) {
                $('#loadingIndicator').hide();
                $('#errorMessage').text('Failed to load parts: ' + error);
            }
        });
    }

    function displayParts(parts) {
        parts.forEach(part => {
            $('#partsList').append(`
                <div class="card mb-3">
                    <div class="card-body" data-part-id="${part.id}">
                        <h5 class="card-title">${part.name} (Part Number: ${part.partNumber})</h5>
                        <p class="card-text">Status: ${part.status}</p>
                        <p class="card-text">Quantity: ${part.quantity}</p>
                        <p class="card-text">Location: ${part.location}</p>
                        <button class="btn btn-outline-secondary" onclick="editPart('${part.id}')">Edit</button>
                        <button class="btn btn-outline-danger delete-button">Delete</button>
                    </div>
                </div>
            `);
        });
    }

    function setupPagination(response) {
        $('#pagination').empty(); // Clear previous pagination
        if (response.has_previous) {
            $('#pagination').append(`
                <button class="btn btn-secondary" onclick="changePage(${response.previous_page_number})">Previous</button>
            `);
        }
        for (let i = 1; i <= Math.ceil(response.totalItems / itemsPerPage); i++) {
            $('#pagination').append(`
                <button class="btn btn-secondary ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>
            `);
        }
        if (response.has_next) {
            $('#pagination').append(`
                <button class="btn btn-secondary" onclick="changePage(${response.next_page_number})">Next</button>
            `);
        }
    }

    function searchParts() {
        const searchTerm = $('#searchInput').val().toLowerCase();
        clearPage();
        currentPage = 1; // Reset to first page
        const filteredParts = inventoryParts.filter(part =>
            part.partNumber.toLowerCase().includes(searchTerm)
            || part.name.toLowerCase().includes(searchTerm)
        );
        displayParts(filteredParts);
        setupPagination(filteredParts.length);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Check if this cookie string begins with the name we want
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function deletePart(partId) {
        $.ajax({
            url: `/parts/delete`,
            type: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')  // Include the CSRF token in the headers
            },
            data: JSON.stringify({
                id: partIdToDelete
            }),
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    fetchParts(); // Refresh the list after deletion
                } else {
                    showToast(response.message, 'danger');
                }
            },
            error: function(xhr, status, error) {
                showAlert('Failed to delete item: ' + xhr.responseText, 'danger');
            }
        });
    }

    function clearPage() {
        $('#partsList').empty();
        $('#pagination').empty();
        $('#errorMessage').text('');
    }

    function showToast(message, type) {
        const toastHTML = `
            <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;

        const toastContainer = document.querySelector('.toast-container');
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);

        const toastElement = toastContainer.lastElementChild;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    }


    // Initial fetch to load all parts
    $(document).ready(function() {
        $('body').on('click', '.delete-button', function() {

            partIdToDelete = $(this).parent().data('part-id'); // Get the item ID from the clicked button
            $('#deleteConfirmationModal').modal('show'); // Show the modal
        });

        $('body').on('click', '#confirmDeleteButton', function() {
            $('#deleteConfirmationModal').modal('hide');
            deletePart();
        });

        fetchParts();
    });
</script>

{% endblock %}
